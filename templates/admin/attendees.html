{% extends "base.html" %}

{% block title %}Attendees - CertifyHub{% endblock %}

{% block content %}
<!-- v3 -->
<style>
    .modal-backdrop.show { opacity: 0.85; }
</style>
<div class="container-fluid">
    <!-- Page Header -->
    <div class="row mb-4">
        <div class="col-12 d-flex justify-content-between align-items-center">
            <div>
                <h1 class="h3 fw-bold">
                    <i class="fas fa-users text-danger"></i> Attendees
                </h1>
                <p class="text-muted mb-0">Manage event attendees and their certificates</p>
            </div>
            <button class="btn btn-danger btn-lg" id="openImportBtn">
                <i class="fas fa-upload"></i> Import Attendees
            </button>
        </div>
    </div>

    <!-- Stats -->
    <div class="row g-4 mb-4">
        <div class="col-md-3">
            <div class="card border-0 shadow-sm">
                <div class="card-body">
                    <small class="text-muted d-block mb-1">Total Attendees</small>
                    <h3 class="fw-bold mb-0" id="totalAttendees">-</h3>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-0 shadow-sm">
                <div class="card-body">
                    <small class="text-muted d-block mb-1">With Certificates</small>
                    <h3 class="fw-bold mb-0" id="withCerts">-</h3>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-0 shadow-sm">
                <div class="card-body">
                    <small class="text-muted d-block mb-1">Pending</small>
                    <h3 class="fw-bold mb-0" id="pending">-</h3>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-0 shadow-sm">
                <div class="card-body">
                    <small class="text-muted d-block mb-1">Completion Rate</small>
                    <h3 class="fw-bold mb-0" id="completionRate">-%</h3>
                </div>
            </div>
        </div>
    </div>

    <!-- Search and Filter -->
    <div class="row mb-4">
        <div class="col-md-4">
            <input type="text" class="form-control form-control-lg" id="searchInput"
                   placeholder="Search by name or ID...">
        </div>
        <div class="col-md-2">
            <select class="form-select form-select-lg" id="statusFilter">
                <option value="">All Attendees</option>
                <option value="with-cert">With Certificate</option>
                <option value="pending">Pending</option>
            </select>
        </div>
        <div class="col-md-2">
            <select class="form-select form-select-lg" id="roleFilter">
                <option value="">All Roles</option>
                <option value="student">Student</option>
                <option value="management">Management</option>
            </select>
        </div>
        <div class="col-md-2">
            <select class="form-select form-select-lg" id="pageSize">
                <option value="10">10 per page</option>
                <option value="25">25 per page</option>
                <option value="50">50 per page</option>
            </select>
        </div>
        <div class="col-md-2">
            <button class="btn btn-outline-secondary w-100 btn-lg" id="refreshBtn">
                <i class="fas fa-sync"></i> Refresh
            </button>
        </div>
    </div>

    <div id="mainMsg" class="mb-3"></div>

    <!-- Attendees Table -->
    <div class="row">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="fas fa-list"></i> All Attendees</h5>
                    <span class="badge bg-danger" id="attendeeCountBadge">0</span>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>Name</th>
                                    <th>Student ID</th>
                                    <th>Email</th>
                                    <th>Course/Batch</th>
                                    <th>Role</th>
                                    <th>Certificates</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody id="attendeesTable">
                                <tr><td colspan="7" class="text-center py-4">
                                    <div class="spinner-border text-danger"></div>
                                </td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Pagination -->
    <nav class="mt-4" id="pagination"></nav>

    <!-- Confirm / Cancel below main table -->
    <div class="justify-content-center gap-2 mt-3 d-none" id="mainActions">
        <button class="btn btn-outline-secondary" id="cancelBtn">
            <i class="fas fa-times me-1"></i>Cancel
        </button>
        <button class="btn btn-danger" id="confirmBtn">
            <i class="fas fa-check me-1"></i>Confirm
        </button>
    </div>
</div>

<!-- ========== IMPORT MODAL ========== -->
<div class="modal fade" id="importModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title"><i class="fas fa-upload me-2"></i>Import Attendees from CSV</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <!-- STEP 1: Select file -->
                <div id="importStep1">
                    <div class="row g-3 align-items-end">
                        <div class="col-md-4">
                            <label class="form-label fw-bold">Batch Name <span class="text-muted fw-normal">(Optional)</span></label>
                            <input type="text" id="batchName" class="form-control" placeholder="e.g., Workshop Jan 2026">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label fw-bold">Default Role</label>
                            <select class="form-select" id="defaultRole">
                                <option value="student" selected>Student</option>
                                <option value="management">Management</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label fw-bold">CSV File</label>
                            <input type="file" id="csvFile" class="form-control" accept=".csv">
                        </div>
                        <div class="col-md-2">
                            <button class="btn btn-danger w-100" id="importBtn">
                                <i class="fas fa-file-import me-1"></i>Import
                            </button>
                        </div>
                    </div>
                    <div class="mt-3 p-3 bg-light rounded">
                        <small class="text-muted">
                            <i class="fas fa-info-circle me-1"></i>
                            <strong>Supported columns:</strong> name, student_id, email, course, role.
                            Missing columns will appear empty.
                        </small>
                    </div>
                </div>

                <!-- Messages -->
                <div id="importMsg" class="mt-3"></div>
            </div>
        </div>
    </div>
</div>

<!-- Toast -->
<div class="position-fixed top-0 end-0 p-3" style="z-index:1100">
    <div id="toast" class="toast align-items-center text-bg-success border-0" role="alert">
        <div class="d-flex">
            <div class="toast-body"><i class="fas fa-check-circle me-2"></i><span id="toastMsg"></span></div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
    </div>
</div>

<script src="/static/js/api.js"></script>
<script>
// ==================== STATE ====================
let allAttendees = [];
let currentPage = 1;
let pageSize = 10;
let previewRows = [];
let selectedFile = null;
let skipResetOnHide = false;
let importModalEl, importModal;

// ==================== INIT ====================
document.addEventListener('DOMContentLoaded', async () => {
    importModalEl = document.getElementById('importModal');
    importModal = new bootstrap.Modal(importModalEl);

    const ok = await checkAuth();
    if (!ok) return;

    // Event listeners
    document.getElementById('openImportBtn').addEventListener('click', openImport);
    document.getElementById('importBtn').addEventListener('click', doImport);
    document.getElementById('cancelBtn').addEventListener('click', cancelPreview);
    document.getElementById('confirmBtn').addEventListener('click', doConfirm);
    document.getElementById('refreshBtn').addEventListener('click', clearMainTable);
    document.getElementById('searchInput').addEventListener('input', debounce(applyFilters, 300));
    document.getElementById('statusFilter').addEventListener('change', applyFilters);
    document.getElementById('roleFilter').addEventListener('change', applyFilters);
    document.getElementById('pageSize').addEventListener('change', () => {
        pageSize = parseInt(document.getElementById('pageSize').value);
        currentPage = 1;
        applyFilters();
    });

    // Reset modal fully when hidden (by X, backdrop, or escape)
    importModalEl.addEventListener('hidden.bs.modal', resetImport);

    resetImport();
    clearMainTable();
});

async function checkAuth() {
    const r = await API.request('/auth/me');
    if (!r || !r.ok || r.data?.user_type !== 'club_admin') {
        window.location.href = '/login';
        return false;
    }
    if (r.data?.club_id) localStorage.setItem('club_id', r.data.club_id);
    return true;
}

// ==================== IMPORT ====================
function openImport() {
    resetImport();
    importModal.show();
}

function resetImport() {
    if (skipResetOnHide) {
        skipResetOnHide = false;
        return;
    }
    document.getElementById('batchName').value = '';
    document.getElementById('defaultRole').value = 'student';
    document.getElementById('csvFile').value = '';
    document.getElementById('importMsg').innerHTML = '';
    document.getElementById('importStep1').style.display = 'block';
    previewRows = [];
    selectedFile = null;
    showMainActions(false);
}

function doImport() {
    const fileInput = document.getElementById('csvFile');
    const file = fileInput.files[0];
    if (!file) {
        showImportMsg('Please select a CSV file first.', 'danger');
        return;
    }
    selectedFile = file;
    const reader = new FileReader();
    reader.onload = (e) => parseAndPreview(e.target.result);
    reader.readAsText(file);
}

function parseAndPreview(text) {
    const lines = text.split(/\r?\n/).filter(l => l.trim());
    if (lines.length < 2) {
        showImportMsg('CSV file is empty or has no data rows.', 'danger');
        return;
    }

    const rawHeaders = lines[0].split(',').map(h =>
        h.trim().toLowerCase().replace(/^\ufeff/, '').replace(/['"]/g, '')
    );

    const ALIASES = {
        name: ['name', 'full name', 'fullname'],
        student_id: ['student_id', 'student id', 'studentid', 'id', 'student', 'roll', 'rollno', 'roll_no', 'roll no'],
        email: ['email', 'email address', 'mail'],
        course: ['course', 'program', 'class', 'department'],
        role: ['role', 'type']
    };

    function findIdx(aliases) {
        for (const a of aliases) { const i = rawHeaders.indexOf(a); if (i !== -1) return i; }
        return -1;
    }

    const idx = {
        name: findIdx(ALIASES.name),
        sid: findIdx(ALIASES.student_id),
        email: findIdx(ALIASES.email),
        course: findIdx(ALIASES.course),
        role: findIdx(ALIASES.role)
    };

    const defaultRole = document.getElementById('defaultRole').value;
    previewRows = [];

    for (let i = 1; i < lines.length; i++) {
        const vals = parseLine(lines[i]);
        if (!vals.length) continue;
        const name = idx.name !== -1 ? (vals[idx.name] || '').trim() : '';
        const sid  = idx.sid  !== -1 ? (vals[idx.sid]  || '').trim() : '';
        if (!name && !sid) continue;
        previewRows.push({
            name, student_id: sid,
            email:  idx.email  !== -1 ? (vals[idx.email]  || '').trim() : '',
            course: idx.course !== -1 ? (vals[idx.course] || '').trim() : '',
            role:   idx.role   !== -1 && vals[idx.role] ? vals[idx.role].trim().toLowerCase() : defaultRole
        });
    }

    if (!previewRows.length) {
        showImportMsg('No valid data rows found in CSV.', 'danger');
        return;
    }

    setMainTable(previewRows.map(r => ({
        ...r,
        certificate_generated_count: 0
    })));
    showMainActions(true);
    skipResetOnHide = true;
    importModal.hide();
    document.getElementById('importMsg').innerHTML = '';
}

function parseLine(line) {
    const res = []; let cur = ''; let inQ = false;
    for (let i = 0; i < line.length; i++) {
        const c = line[i];
        if (c === '"') inQ = !inQ;
        else if (c === ',' && !inQ) { res.push(cur); cur = ''; }
        else cur += c;
    }
    res.push(cur);
    return res;
}

function cancelPreview(keepMsg = false) {
    document.getElementById('csvFile').value = '';
    if (!keepMsg) document.getElementById('importMsg').innerHTML = '';
    previewRows = [];
    selectedFile = null;
    clearMainTable();
    showMainActions(false);
}

async function doConfirm() {
    if (!selectedFile || !previewRows.length) return;

    const batch = document.getElementById('batchName').value.trim();
    const role = document.getElementById('defaultRole').value;
    const fd = new FormData();
    fd.append('file', selectedFile);
    fd.append('batch_name', batch || selectedFile.name.replace(/\.csv$/i, ''));
    fd.append('role', role);

    const btn = document.getElementById('confirmBtn');
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Saving...';

    const r = await API.request('/admin/attendees/import-simple', { method: 'POST', body: fd });

    btn.disabled = false;
    btn.innerHTML = '<i class="fas fa-check me-1"></i>Confirm';

    if (!r || !r.ok) {
        showMainMsg(r?.data?.detail || 'Failed to import. Please try again.', 'danger');
        return;
    }

    const d = r.data || {};
    showMainMsg(`Saved ${d.imported || 0} attendees. ${d.duplicates || 0} duplicates skipped.`, 'success');
    showToast(`Saved ${d.imported || 0} attendees.`);
    cancelPreview(true);
}

function showImportMsg(text, type) {
    const level = (type === 'danger' || type === 'success') ? type : 'info';
    document.getElementById('importMsg').innerHTML =
        `<div class="alert alert-${level} mb-0">${text}</div>`;
}

// ==================== ATTENDEES TABLE ====================
function updateStats(list) {
    const wc = list.filter(a => a.certificate_generated_count > 0).length;
    const pend = list.length - wc;
    const rate = list.length ? Math.round(wc / list.length * 100) : 0;

    document.getElementById('totalAttendees').textContent = list.length;
    document.getElementById('withCerts').textContent = wc;
    document.getElementById('pending').textContent = pend;
    document.getElementById('completionRate').textContent = rate + '%';
    document.getElementById('attendeeCountBadge').textContent = list.length;
}

function setMainTable(rows) {
    allAttendees = rows;
    updateStats(allAttendees);
    applyFilters();
}

function clearMainTable() {
    allAttendees = [];
    updateStats(allAttendees);
    renderTable([]);
    showMainActions(false);
}

function showMainMsg(text, type) {
    const level = (type === 'danger' || type === 'success') ? type : 'info';
    document.getElementById('mainMsg').innerHTML =
        `<div class="alert alert-${level} mb-0">${text}</div>`;
}

function showMainActions(show) {
    const el = document.getElementById('mainActions');
    if (show) {
        el.classList.remove('d-none');
        el.classList.add('d-flex');
    } else {
        el.classList.add('d-none');
        el.classList.remove('d-flex');
    }
}

function applyFilters() {
    let list = [...allAttendees];
    const q = document.getElementById('searchInput').value.toLowerCase();
    if (q) list = list.filter(a =>
        a.name.toLowerCase().includes(q) ||
        a.student_id.toLowerCase().includes(q) ||
        (a.email || '').toLowerCase().includes(q));

    const sf = document.getElementById('statusFilter').value;
    if (sf === 'with-cert') list = list.filter(a => a.certificate_generated_count > 0);
    else if (sf === 'pending') list = list.filter(a => a.certificate_generated_count === 0);

    const rf = document.getElementById('roleFilter').value;
    if (rf) list = list.filter(a => (a.role || 'student') === rf);

    renderTable(list);
}

function renderTable(list) {
    const tbody = document.getElementById('attendeesTable');
    if (!list.length) {
        tbody.innerHTML = `<tr><td colspan="7" class="text-center py-5">
            <i class="fas fa-inbox text-muted" style="font-size:3rem"></i>
            <p class="text-muted mt-3">No preview yet. Import a CSV to view it here.</p>
            <button class="btn btn-danger" id="emptyImportBtn">
                <i class="fas fa-upload me-1"></i>Import Attendees</button>
        </td></tr>`;
        document.getElementById('emptyImportBtn')?.addEventListener('click', openImport);
        document.getElementById('pagination').innerHTML = '';
        return;
    }

    const pages = Math.ceil(list.length / pageSize);
    if (currentPage > pages) currentPage = pages;
    const start = (currentPage - 1) * pageSize;
    const slice = list.slice(start, start + pageSize);

    tbody.innerHTML = slice.map(a => {
        const badge = a.certificate_generated_count > 0
            ? `<span class="badge bg-success">Generated (${a.certificate_generated_count})</span>`
            : '<span class="badge bg-warning">Pending</span>';
        return `<tr>
            <td><strong>${esc(a.name)}</strong></td>
            <td><code>${esc(a.student_id)}</code></td>
            <td>${esc(a.email || '-')}</td>
            <td>${esc(a.course || '-')}</td>
            <td><span class="badge bg-info">${a.role || 'student'}</span></td>
            <td>${a.certificate_generated_count || 0}</td>
            <td>${badge}</td>
        </tr>`;
    }).join('');

    renderPages(list.length);
}

function renderPages(total) {
    const pages = Math.ceil(total / pageSize);
    const nav = document.getElementById('pagination');
    if (pages <= 1) { nav.innerHTML = ''; return; }

    let h = '<ul class="pagination justify-content-center">';
    if (currentPage > 1) h += `<li class="page-item"><button class="page-link" data-p="${currentPage-1}">Previous</button></li>`;
    for (let i = 1; i <= pages; i++)
        h += `<li class="page-item ${i===currentPage?'active':''}"><button class="page-link" data-p="${i}">${i}</button></li>`;
    if (currentPage < pages) h += `<li class="page-item"><button class="page-link" data-p="${currentPage+1}">Next</button></li>`;
    h += '</ul>';
    nav.innerHTML = h;
    nav.querySelectorAll('[data-p]').forEach(btn => btn.addEventListener('click', () => {
        currentPage = parseInt(btn.dataset.p);
        applyFilters();
        window.scrollTo({top: 0, behavior: 'smooth'});
    }));
}

// ==================== UTILS ====================
function esc(t) {
    if (!t) return '';
    const m = {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'};
    return String(t).replace(/[&<>"']/g, c => m[c]);
}

function debounce(fn, ms) {
    let t; return (...a) => { clearTimeout(t); t = setTimeout(() => fn(...a), ms); };
}

function showToast(msg) {
    document.getElementById('toastMsg').textContent = msg;
    new bootstrap.Toast(document.getElementById('toast'), {delay: 4000}).show();
}

function showErr(msg) {
    const el = document.createElement('div');
    el.className = 'alert alert-danger alert-dismissible fade show position-fixed top-0 start-50 translate-middle-x mt-3';
    el.style.zIndex = '9999';
    el.innerHTML = `<i class="fas fa-exclamation-circle"></i> ${msg}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>`;
    document.body.appendChild(el);
    setTimeout(() => el.remove(), 5000);
}
</script>
{% endblock %}
