{% extends "base.html" %}

{% block title %}Attendees - CertifyHub{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Page Header -->
    <div class="row mb-4">
        <div class="col-12 d-flex justify-content-between align-items-center">
            <div>
                <h1 class="h3 fw-bold">
                    <i class="fas fa-users text-danger"></i> Attendees
                </h1>
                <p class="text-muted">Manage event attendees and their certificates</p>
            </div>
            <button class="btn btn-danger btn-lg" onclick="openUploadPanel()">
                <i class="fas fa-upload"></i> Import Attendees
            </button>
        </div>
    </div>

    <!-- Stats -->
    <div class="row g-4 mb-4">
        <div class="col-md-3">
            <div class="card border-0 shadow-sm">
                <div class="card-body">
                    <small class="text-muted d-block mb-1">Total Attendees</small>
                    <h3 class="fw-bold mb-0" id="totalAttendees">-</h3>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-0 shadow-sm">
                <div class="card-body">
                    <small class="text-muted d-block mb-1">With Certificates</small>
                    <h3 class="fw-bold mb-0" id="withCerts">-</h3>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-0 shadow-sm">
                <div class="card-body">
                    <small class="text-muted d-block mb-1">Pending</small>
                    <h3 class="fw-bold mb-0" id="pending">-</h3>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-0 shadow-sm">
                <div class="card-body">
                    <small class="text-muted d-block mb-1">Completion Rate</small>
                    <h3 class="fw-bold mb-0" id="completionRate">-%</h3>
                </div>
            </div>
        </div>
    </div>

    <!-- Search and Filter -->
    <div class="row mb-4">
        <div class="col-md-4">
            <input type="text" class="form-control form-control-lg" id="searchInput" 
                   placeholder="Search by name or ID...">
        </div>
        <div class="col-md-2">
            <select class="form-select form-select-lg" id="statusFilter">
                <option value="">All Attendees</option>
                <option value="with-cert">With Certificate</option>
                <option value="pending">Pending</option>
            </select>
        </div>
        <div class="col-md-2">
            <select class="form-select form-select-lg" id="roleFilter">
                <option value="">All Roles</option>
                <option value="student">Student</option>
                <option value="management">Management</option>
            </select>
        </div>
        <div class="col-md-2">
            <select class="form-select form-select-lg" id="pageSize">
                <option value="10">10 per page</option>
                <option value="25">25 per page</option>
                <option value="50">50 per page</option>
            </select>
        </div>
        <div class="col-md-2">
            <button class="btn btn-outline-secondary w-100 btn-lg" onclick="loadAttendees()">
                <i class="fas fa-sync"></i> Refresh
            </button>
        </div>
    </div>

    <!-- Attendees Table -->
    <div class="row">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="fas fa-list"></i> All Attendees</h5>
                    <span class="badge bg-danger" id="attendeeCountBadge">0</span>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>Name</th>
                                    <th>Student ID</th>
                                    <th>Email</th>
                                    <th>Course/Batch</th>
                                    <th>Role</th>
                                    <th>Certificates</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="attendeesTable">
                                <tr>
                                    <td colspan="8" class="text-center py-4">
                                        <div class="spinner-border text-danger" role="status">
                                            <span class="visually-hidden">Loading...</span>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Pagination -->
    <nav class="mt-4" id="pagination"></nav>
</div>

<!-- Import Attendees Modal -->
<div class="modal fade" id="uploadModal" tabindex="-1" data-bs-backdrop="static">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">
                    <i class="fas fa-upload"></i> Import Attendees from CSV
                </h5>
                <button type="button" class="btn-close btn-close-white" onclick="closeUploadPanel()"></button>
            </div>
            <div class="modal-body">
                <!-- Step 1: File Selection -->
                <div id="step1" class="upload-step">
                    <div class="row g-3">
                        <div class="col-md-4">
                            <label class="form-label fw-bold">Batch Name (Optional)</label>
                            <input type="text" id="uploadBatchName" class="form-control" placeholder="e.g., Workshop Jan 2026">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label fw-bold">Default Role</label>
                            <select class="form-select" id="uploadRole">
                                <option value="student" selected>Student</option>
                                <option value="management">Management</option>
                            </select>
                        </div>
                        <div class="col-md-5">
                            <label class="form-label fw-bold">CSV File</label>
                            <input type="file" id="uploadFile" class="form-control" accept=".csv" onchange="previewCSV()">
                        </div>
                    </div>
                    <div class="mt-3 p-3 bg-light rounded">
                        <small class="text-muted">
                            <i class="fas fa-info-circle"></i> 
                            <strong>Required columns:</strong> name, student_id<br>
                            <strong>Optional columns:</strong> email, course, role
                        </small>
                    </div>
                </div>

                <!-- Step 2: Preview -->
                <div id="step2" class="upload-step" style="display: none;">
                    <div class="alert alert-info">
                        <i class="fas fa-eye"></i> <strong>Preview:</strong> Review the data below before importing.
                        <span id="previewCount" class="badge bg-primary ms-2">0 records</span>
                    </div>
                    <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                        <table class="table table-sm table-bordered">
                            <thead class="table-dark sticky-top">
                                <tr>
                                    <th>#</th>
                                    <th>Name</th>
                                    <th>Student ID</th>
                                    <th>Email</th>
                                    <th>Course</th>
                                    <th>Role</th>
                                </tr>
                            </thead>
                            <tbody id="previewTable"></tbody>
                        </table>
                    </div>
                </div>

                <!-- Messages -->
                <div class="mt-3" id="uploadMessage"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeUploadPanel()">
                    <i class="fas fa-times"></i> Cancel
                </button>
                <button type="button" class="btn btn-outline-primary" id="backBtn" onclick="backToStep1()" style="display: none;">
                    <i class="fas fa-arrow-left"></i> Back
                </button>
                <button type="button" class="btn btn-danger" id="importBtn" onclick="confirmImport()" disabled>
                    <i class="fas fa-check"></i> Import <span id="importCountBtn"></span>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Attendee Details Modal -->
<div class="modal fade" id="detailsModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-user-circle text-danger"></i> Attendee Details
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="detailsContent">Loading...</div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-danger" id="downloadCertBtn" onclick="downloadCertificate()" style="display:none;">
                    <i class="fas fa-download"></i> Download Certificate
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Toast Notification -->
<div class="position-fixed top-0 end-0 p-3" style="z-index: 1100">
    <div id="successToast" class="toast align-items-center text-bg-success border-0" role="alert">
        <div class="d-flex">
            <div class="toast-body">
                <i class="fas fa-check-circle me-2"></i>
                <span id="toastMessage">Success!</span>
            </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
    </div>
</div>

<script src="/static/js/api.js"></script>
<script>
let allAttendees = [];
let currentPage = 1;
let pageSize = 10;
let currentAttendeeId = null;
let previewData = [];
let uploadModal = null;

document.addEventListener('DOMContentLoaded', async function() {
    uploadModal = new bootstrap.Modal(document.getElementById('uploadModal'));
    
    // Verify authentication first
    const authOk = await verifyAuth();
    if (!authOk) return;
    
    document.getElementById('pageSize').addEventListener('change', function() {
        pageSize = parseInt(this.value);
        currentPage = 1;
        filterAttendees();
    });
    
    document.getElementById('searchInput').addEventListener('keyup', debounce(filterAttendees, 300));
    document.getElementById('statusFilter').addEventListener('change', filterAttendees);
    document.getElementById('roleFilter').addEventListener('change', filterAttendees);
    
    loadAttendees();
});

async function verifyAuth() {
    const response = await API.request('/auth/me');
    if (!response || !response.ok) {
        window.location.href = '/login';
        return false;
    }
    
    const userType = response.data?.user_type;
    if (userType !== 'club_admin') {
        alert('Access denied. Please log in with a club admin account.');
        window.location.href = '/login';
        return false;
    }
    
    if (response.data?.club_id) {
        localStorage.setItem('club_id', response.data.club_id);
    }
    return true;
}

function openUploadPanel() {
    resetUploadPanel();
    uploadModal.show();
}

function closeUploadPanel() {
    resetUploadPanel();
    uploadModal.hide();
}

function resetUploadPanel() {
    document.getElementById('uploadBatchName').value = '';
    document.getElementById('uploadRole').value = 'student';
    document.getElementById('uploadFile').value = '';
    document.getElementById('uploadMessage').innerHTML = '';
    document.getElementById('previewTable').innerHTML = '';
    document.getElementById('step1').style.display = 'block';
    document.getElementById('step2').style.display = 'none';
    document.getElementById('backBtn').style.display = 'none';
    document.getElementById('importBtn').disabled = true;
    document.getElementById('importCountBtn').textContent = '';
    previewData = [];
}

function previewCSV() {
    const file = document.getElementById('uploadFile').files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = function(e) {
        const text = e.target.result;
        parseCSV(text);
    };
    reader.readAsText(file);
}

function parseCSV(text) {
    const lines = text.split(/\r?\n/).filter(line => line.trim());
    if (lines.length < 2) {
        showUploadMessage('CSV file is empty or has no data rows.', 'danger');
        return;
    }

    // Parse headers
    const headers = lines[0].split(',').map(h => h.trim().toLowerCase().replace(/^\ufeff/, ''));
    const nameIdx = headers.indexOf('name');
    const sidIdx = headers.indexOf('student_id');
    const emailIdx = headers.indexOf('email');
    const courseIdx = headers.indexOf('course');
    const roleIdx = headers.indexOf('role');

    if (nameIdx === -1 || sidIdx === -1) {
        showUploadMessage('CSV must have "name" and "student_id" columns.', 'danger');
        return;
    }

    const defaultRole = document.getElementById('uploadRole').value;
    previewData = [];

    for (let i = 1; i < lines.length; i++) {
        const values = parseCSVLine(lines[i]);
        if (values.length === 0) continue;

        const name = (values[nameIdx] || '').trim();
        const studentId = (values[sidIdx] || '').trim();
        
        if (!name || !studentId) continue;

        previewData.push({
            name: name,
            student_id: studentId,
            email: emailIdx !== -1 ? (values[emailIdx] || '').trim() : '',
            course: courseIdx !== -1 ? (values[courseIdx] || '').trim() : '',
            role: roleIdx !== -1 && values[roleIdx] ? values[roleIdx].trim().toLowerCase() : defaultRole
        });
    }

    if (previewData.length === 0) {
        showUploadMessage('No valid data rows found in CSV.', 'danger');
        return;
    }

    // Show preview
    showPreview();
}

function parseCSVLine(line) {
    const result = [];
    let current = '';
    let inQuotes = false;
    
    for (let i = 0; i < line.length; i++) {
        const char = line[i];
        if (char === '"') {
            inQuotes = !inQuotes;
        } else if (char === ',' && !inQuotes) {
            result.push(current);
            current = '';
        } else {
            current += char;
        }
    }
    result.push(current);
    return result;
}

function showPreview() {
    const tbody = document.getElementById('previewTable');
    tbody.innerHTML = previewData.map((row, idx) => `
        <tr>
            <td>${idx + 1}</td>
            <td>${escapeHtml(row.name)}</td>
            <td><code>${escapeHtml(row.student_id)}</code></td>
            <td>${escapeHtml(row.email || '-')}</td>
            <td>${escapeHtml(row.course || '-')}</td>
            <td><span class="badge bg-info">${row.role}</span></td>
        </tr>
    `).join('');

    document.getElementById('previewCount').textContent = `${previewData.length} records`;
    document.getElementById('importCountBtn').textContent = `(${previewData.length} records)`;
    
    document.getElementById('step1').style.display = 'none';
    document.getElementById('step2').style.display = 'block';
    document.getElementById('backBtn').style.display = 'inline-block';
    document.getElementById('importBtn').disabled = false;
    document.getElementById('uploadMessage').innerHTML = '';
}

function backToStep1() {
    document.getElementById('step1').style.display = 'block';
    document.getElementById('step2').style.display = 'none';
    document.getElementById('backBtn').style.display = 'none';
    document.getElementById('importBtn').disabled = true;
    document.getElementById('importCountBtn').textContent = '';
}

async function confirmImport() {
    const file = document.getElementById('uploadFile').files[0];
    if (!file || previewData.length === 0) return;

    const batchName = document.getElementById('uploadBatchName').value.trim();
    const role = document.getElementById('uploadRole').value;

    const formData = new FormData();
    formData.append('file', file);
    formData.append('batch_name', batchName || file.name.replace(/\.csv$/i, ''));
    formData.append('role', role);

    document.getElementById('importBtn').disabled = true;
    document.getElementById('importBtn').innerHTML = '<i class="fas fa-spinner fa-spin"></i> Importing...';

    const response = await API.request('/admin/attendees/import-simple', {
        method: 'POST',
        body: formData
    });

    document.getElementById('importBtn').disabled = false;
    document.getElementById('importBtn').innerHTML = '<i class="fas fa-check"></i> Import';

    if (!response) {
        showUploadMessage('Not authenticated. Please log in again.', 'danger');
        return;
    }

    if (!response.ok) {
        showUploadMessage(response.data?.detail || 'Failed to import attendees.', 'danger');
        return;
    }

    const data = response.data || {};
    showToast(`Imported ${data.imported || 0} attendees. ${data.duplicates || 0} duplicates skipped.`);
    closeUploadPanel();
    loadAttendees();
}

function showUploadMessage(text, type) {
    const cls = type === 'danger' ? 'alert-danger' : type === 'success' ? 'alert-success' : 'alert-info';
    document.getElementById('uploadMessage').innerHTML = `<div class="alert ${cls}">${text}</div>`;
}

function showToast(message) {
    document.getElementById('toastMessage').textContent = message;
    const toast = new bootstrap.Toast(document.getElementById('successToast'), { delay: 4000 });
    toast.show();
}

async function loadAttendees() {
    try {
        const response = await API.request('/admin/attendees');
        
        if (!response) {
            showError('Not authenticated. Please log in again.');
            return;
        }
        
        if (response.ok) {
            const data = response.data || {};
            allAttendees = data.attendees || [];
            
            // Update stats
            const withCerts = allAttendees.filter(a => a.certificate_generated_count > 0).length;
            const pending = allAttendees.length - withCerts;
            const completionRate = allAttendees.length > 0 
                ? Math.round((withCerts / allAttendees.length) * 100) 
                : 0;
            
            document.getElementById('totalAttendees').textContent = allAttendees.length;
            document.getElementById('withCerts').textContent = withCerts;
            document.getElementById('pending').textContent = pending;
            document.getElementById('completionRate').textContent = completionRate + '%';
            document.getElementById('attendeeCountBadge').textContent = allAttendees.length;
            
            filterAttendees();
        } else {
            showError('Failed to load attendees');
        }
    } catch (error) {
        console.error('Error:', error);
        showError('Error loading attendees');
    }
}

function filterAttendees() {
    let filtered = [...allAttendees];
    
    const search = document.getElementById('searchInput').value.toLowerCase();
    if (search) {
        filtered = filtered.filter(a => 
            a.name.toLowerCase().includes(search) ||
            a.student_id.toLowerCase().includes(search) ||
            (a.email || '').toLowerCase().includes(search)
        );
    }
    
    const status = document.getElementById('statusFilter').value;
    if (status === 'with-cert') {
        filtered = filtered.filter(a => a.certificate_generated_count > 0);
    } else if (status === 'pending') {
        filtered = filtered.filter(a => a.certificate_generated_count === 0);
    }

    const role = document.getElementById('roleFilter').value;
    if (role) {
        filtered = filtered.filter(a => (a.role || 'student') === role);
    }
    
    renderAttendees(filtered);
}

function renderAttendees(attendees) {
    const tbody = document.getElementById('attendeesTable');
    
    if (attendees.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="8" class="text-center py-5">
                    <i class="fas fa-inbox text-muted" style="font-size: 3rem;"></i>
                    <p class="text-muted mt-3">No attendees found</p>
                    <button class="btn btn-danger" onclick="openUploadPanel()">
                        <i class="fas fa-upload"></i> Import Attendees
                    </button>
                </td>
            </tr>
        `;
        document.getElementById('pagination').innerHTML = '';
        return;
    }
    
    const totalPages = Math.ceil(attendees.length / pageSize);
    const startIdx = (currentPage - 1) * pageSize;
    const pageAttendees = attendees.slice(startIdx, startIdx + pageSize);
    
    tbody.innerHTML = pageAttendees.map(attendee => {
        const statusBadge = attendee.certificate_generated_count > 0
            ? `<span class="badge bg-success">Generated (${attendee.certificate_generated_count})</span>`
            : '<span class="badge bg-warning">Pending</span>';
        
        return `
            <tr>
                <td><strong>${escapeHtml(attendee.name)}</strong></td>
                <td><code>${attendee.student_id}</code></td>
                <td>${escapeHtml(attendee.email || '-')}</td>
                <td>${escapeHtml(attendee.course || '-')}</td>
                <td><span class="badge bg-info">${attendee.role || 'student'}</span></td>
                <td>${attendee.certificate_generated_count || 0}</td>
                <td>${statusBadge}</td>
                <td>
                    <button class="btn btn-sm btn-outline-primary" onclick="showAttendeeDetails('${attendee.id}')" title="View details">
                        <i class="fas fa-eye"></i>
                    </button>
                </td>
            </tr>
        `;
    }).join('');
    
    renderPagination(attendees.length);
}

function renderPagination(totalItems) {
    const totalPages = Math.ceil(totalItems / pageSize);
    const nav = document.getElementById('pagination');
    
    if (totalPages <= 1) {
        nav.innerHTML = '';
        return;
    }
    
    let html = '<ul class="pagination justify-content-center">';
    
    if (currentPage > 1) {
        html += `<li class="page-item"><button class="page-link" onclick="setPage(${currentPage - 1})">Previous</button></li>`;
    }
    
    for (let i = 1; i <= totalPages; i++) {
        const active = i === currentPage ? 'active' : '';
        html += `<li class="page-item ${active}"><button class="page-link" onclick="setPage(${i})">${i}</button></li>`;
    }
    
    if (currentPage < totalPages) {
        html += `<li class="page-item"><button class="page-link" onclick="setPage(${currentPage + 1})">Next</button></li>`;
    }
    
    html += '</ul>';
    nav.innerHTML = html;
}

function setPage(page) {
    currentPage = page;
    filterAttendees();
    window.scrollTo({ top: 0, behavior: 'smooth' });
}

async function showAttendeeDetails(attendeeId) {
    currentAttendeeId = attendeeId;
    try {
        const response = await API.request(`/admin/attendees/${attendeeId}`);
        
        if (response && response.ok) {
            const attendee = response.data;
            let html = `
                <div class="mb-3">
                    <label class="form-label text-muted">Name</label>
                    <p class="fw-bold">${escapeHtml(attendee.name)}</p>
                </div>
                <div class="mb-3">
                    <label class="form-label text-muted">Student ID</label>
                    <p class="fw-bold"><code>${attendee.student_id}</code></p>
                </div>
                <div class="mb-3">
                    <label class="form-label text-muted">Email</label>
                    <p class="fw-bold">${escapeHtml(attendee.email || '-')}</p>
                </div>
                <div class="mb-3">
                    <label class="form-label text-muted">Course/Batch</label>
                    <p class="fw-bold">${escapeHtml(attendee.course || '-')}</p>
                </div>
                <div class="mb-3">
                    <label class="form-label text-muted">Role</label>
                    <p class="fw-bold">${escapeHtml(attendee.role || 'student')}</p>
                </div>
                <div class="mb-3">
                    <label class="form-label text-muted">Certificates Generated</label>
                    <p class="fw-bold"><span class="badge bg-success">${attendee.certificate_generated_count || 0}</span></p>
                </div>
            `;
            
            document.getElementById('detailsContent').innerHTML = html;
            
            const downloadBtn = document.getElementById('downloadCertBtn');
            downloadBtn.style.display = attendee.certificate_generated_count > 0 ? 'block' : 'none';
            
            new bootstrap.Modal(document.getElementById('detailsModal')).show();
        }
    } catch (error) {
        console.error('Error:', error);
        showError('Failed to load attendee details');
    }
}

async function downloadCertificate() {
    if (!currentAttendeeId) return;
    const token = API.getToken();
    window.location.href = `/certificates/download/${currentAttendeeId}?token=${token}`;
}

function escapeHtml(text) {
    if (!text) return '';
    const map = { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;' };
    return String(text).replace(/[&<>"']/g, m => map[m]);
}

function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
}

function showError(message) {
    const alert = document.createElement('div');
    alert.className = 'alert alert-danger alert-dismissible fade show position-fixed top-0 start-50 translate-middle-x mt-3';
    alert.style.zIndex = '9999';
    alert.innerHTML = `
        <i class="fas fa-exclamation-circle"></i> ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    document.body.appendChild(alert);
    setTimeout(() => alert.remove(), 5000);
}
</script>
{% endblock %}
