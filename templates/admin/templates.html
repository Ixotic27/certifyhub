{% extends "base.html" %}

{% block title %}Certificate Templates - CertifyHub{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Page Header -->
    <div class="row mb-4">
        <div class="col-12 d-flex justify-content-between align-items-center">
            <div>
                <h1 class="h3 fw-bold">
                    <i class="fas fa-file-certificate text-danger"></i> Certificate Templates
                </h1>
                <p class="text-muted">Manage your certificate designs</p>
            </div>
            <a href="/admin/ui/templates/create" class="btn btn-danger">
                <i class="fas fa-plus"></i> Create Template
            </a>
        </div>
    </div>

    <!-- Filter and Search -->
    <div class="row mb-4">
        <div class="col-12 mb-3">
            <div class="alert alert-info py-2 mb-0" style="font-size: 0.85rem;">
                <i class="fas fa-clock"></i> <strong>Auto-cleanup:</strong> Templates not used for 30 days are automatically removed. Use your templates regularly to keep them active.
            </div>
        </div>
        <div class="col-md-6">
            <input type="text" class="form-control form-control-lg" id="searchInput" 
                   placeholder="Search templates...">
        </div>
        <div class="col-md-3">
            <select class="form-select form-select-lg" id="statusFilter">
                <option value="">All Templates</option>
                <option value="active">Active Only</option>
                <option value="inactive">Inactive Only</option>
            </select>
        </div>
        <div class="col-md-3">
            <button class="btn btn-outline-secondary w-100" onclick="loadTemplates()">
                <i class="fas fa-sync"></i> Refresh
            </button>
        </div>
    </div>

    <!-- Templates List -->
    <div class="row">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>Template Name</th>
                                    <th>Audience</th>
                                    <th>Created</th>
                                    <th>Attendees</th>
                                    <th>Certificates</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="templatesTable">
                                <tr>
                                    <td colspan="7" class="text-center py-4">
                                        <div class="spinner-border text-danger" role="status">
                                            <span class="visually-hidden">Loading...</span>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Template Modal for Preview -->
<div class="modal fade" id="previewModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="previewTitle">Template Preview</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center">
                <img id="previewImage" src="" alt="Template Preview" style="max-width: 100%; max-height: 400px;">
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header border-danger">
                <h5 class="modal-title text-danger">
                    <i class="fas fa-exclamation-triangle"></i> Delete Template
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to deactivate this template?</p>
                <p class="text-muted small">This action will prevent new certificates from being generated with this template, but existing certificates will remain valid.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" onclick="deleteTemplate()">
                    <i class="fas fa-trash"></i> Deactivate
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Try Certificate Modal -->
<div class="modal fade" id="tryModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Try Certificate</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">CSV Import</label>
                    <select class="form-select" id="tryImport">
                        <option value="">Select a CSV import</option>
                    </select>
                    <div class="form-text">Choose an uploaded CSV to pick a name/student ID.</div>
                </div>
                <div class="mb-3">
                    <label class="form-label">Name (from CSV)</label>
                    <input type="text" class="form-control" id="tryName" placeholder="e.g., John Doe">
                </div>
                <div class="mb-3">
                    <label class="form-label">Student ID (from CSV)</label>
                    <input type="text" class="form-control" id="tryStudentId" placeholder="e.g., STU-001">
                </div>
                <div class="mb-3">
                    <label class="form-label">Role</label>
                    <select class="form-select" id="tryRole">
                        <option value="student" selected>Student / Participant</option>
                        <option value="management">Management Team</option>
                    </select>
                </div>
                <div id="importRows" class="border rounded p-2" style="max-height: 200px; overflow: auto; display: none;"></div>
                <div id="tryError" class="alert alert-danger d-none"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success" onclick="runTryCertificate()">
                    <i class="fas fa-play"></i> Generate
                </button>
            </div>
        </div>
    </div>
</div>

<script>
let currentDeleteId = null;
let allTemplates = [];
let currentTryTemplateId = null;
let currentImports = [];

document.addEventListener('DOMContentLoaded', function() {
    loadTemplates();
    
    // Setup search and filter
    document.getElementById('searchInput').addEventListener('keyup', filterTemplates);
    document.getElementById('statusFilter').addEventListener('change', filterTemplates);
});

async function loadTemplates() {
    try {
        const token = localStorage.getItem('token');
        const response = await fetch('/admin/templates', {
            headers: {
                'Authorization': `Bearer ${token}`
            }
        });
        
        if (response.ok) {
            const data = await response.json();
            allTemplates = data.templates || [];
            renderTemplates(allTemplates);
        } else {
            showError('Failed to load templates');
        }
    } catch (error) {
        console.error('Error:', error);
        showError('Error loading templates');
    }
}

function renderTemplates(templates) {
    const tbody = document.getElementById('templatesTable');
    
    if (templates.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="7" class="text-center py-5">
                    <i class="fas fa-folder-open text-muted" style="font-size: 3rem;"></i>
                    <p class="text-muted mt-3">No templates found. <a href="/admin/ui/templates/create">Create one</a></p>
                </td>
            </tr>
        `;
        return;
    }
    
    tbody.innerHTML = templates.map(template => {
        const createdDate = new Date(template.created_at).toLocaleDateString();
        const statusBadge = template.is_active 
            ? '<span class="badge bg-success">Active</span>'
            : '<span class="badge bg-secondary">Inactive</span>';
        
        return `
            <tr>
                <td>
                    <strong>${escapeHtml(template.name)}</strong><br>
                    <small class="text-muted">${template.id}</small>
                </td>
                <td><span class="badge bg-info">${template.audience || 'student'}</span></td>
                <td>${createdDate}</td>
                <td>
                    <span class="badge bg-info">${template.attendee_count || 0}</span>
                </td>
                <td>
                    <span class="badge bg-success">${template.certificate_count || 0}</span>
                </td>
                <td>${statusBadge}</td>
                <td>
                    <div class="btn-group btn-group-sm">
                        <button class="btn btn-outline-primary" onclick="previewTemplate('${template.id}')" 
                                title="Preview">
                            <i class="fas fa-eye"></i>
                        </button>
                        <a href="/admin/ui/templates/create?template_id=${template.id}" class="btn btn-outline-warning" title="Edit">
                            <i class="fas fa-edit"></i>
                        </a>
                        <button class="btn btn-outline-success" onclick="openTryModal('${template.id}', '${template.audience || 'student'}')" 
                                title="Try">
                            <i class="fas fa-flask"></i>
                        </button>
                        <button class="btn btn-outline-danger" onclick="showDeleteModal('${template.id}')" 
                                title="Deactivate">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </td>
            </tr>
        `;
    }).join('');
}

function filterTemplates() {
    let filtered = [...allTemplates];
    
    // Search filter
    const search = document.getElementById('searchInput').value.toLowerCase();
    if (search) {
        filtered = filtered.filter(t => 
            t.name.toLowerCase().includes(search) ||
            t.id.toLowerCase().includes(search)
        );
    }
    
    // Status filter
    const status = document.getElementById('statusFilter').value;
    if (status === 'active') {
        filtered = filtered.filter(t => t.is_active);
    } else if (status === 'inactive') {
        filtered = filtered.filter(t => !t.is_active);
    }
    
    renderTemplates(filtered);
}

async function previewTemplate(templateId) {
    try {
        const token = localStorage.getItem('token');
        const response = await fetch(`/admin/templates/${templateId}`, {
            headers: {
                'Authorization': `Bearer ${token}`
            }
        });
        
        if (response.ok) {
            const data = await response.json();
            document.getElementById('previewTitle').textContent = data.name;
            document.getElementById('previewImage').src = data.template_image_url;
            new bootstrap.Modal(document.getElementById('previewModal')).show();
        }
    } catch (error) {
        console.error('Error:', error);
        showError('Failed to load preview');
    }
}

function showDeleteModal(templateId) {
    currentDeleteId = templateId;
    new bootstrap.Modal(document.getElementById('deleteModal')).show();
}

function openTryModal(templateId, audience) {
    currentTryTemplateId = templateId;
    document.getElementById('tryName').value = '';
    document.getElementById('tryStudentId').value = '';
    document.getElementById('tryRole').value = audience || 'student';
    const errorBox = document.getElementById('tryError');
    errorBox.classList.add('d-none');
    errorBox.textContent = '';
    loadImports();
    new bootstrap.Modal(document.getElementById('tryModal')).show();
}

async function loadImports() {
    const select = document.getElementById('tryImport');
    const rowsBox = document.getElementById('importRows');
    rowsBox.style.display = 'none';
    rowsBox.innerHTML = '';
    select.innerHTML = '<option value="">Select a CSV import</option>';

    try {
        const token = localStorage.getItem('token');
        const response = await fetch('/admin/attendees/imports', {
            headers: { 'Authorization': `Bearer ${token}` }
        });
        if (!response.ok) return;
        const data = await response.json();
        currentImports = data.imports || [];
        currentImports.forEach(imp => {
            const option = document.createElement('option');
            const uploadedAt = imp.uploaded_at ? new Date(imp.uploaded_at).toLocaleString() : '';
            option.value = imp.id;
            option.textContent = `${imp.filename} (${imp.role}) ${uploadedAt}`;
            select.appendChild(option);
        });
    } catch (error) {
        console.error('Failed to load imports', error);
    }

    select.onchange = () => {
        if (select.value) {
            loadImportRows(select.value);
        } else {
            rowsBox.style.display = 'none';
            rowsBox.innerHTML = '';
        }
    };
}

async function loadImportRows(importId) {
    const rowsBox = document.getElementById('importRows');
    rowsBox.innerHTML = '<div class="text-muted">Loading rows...</div>';
    rowsBox.style.display = 'block';

    try {
        const token = localStorage.getItem('token');
        const response = await fetch(`/admin/attendees/imports/${importId}/rows?limit=100`, {
            headers: { 'Authorization': `Bearer ${token}` }
        });
        if (!response.ok) {
            rowsBox.innerHTML = '<div class="text-danger">Failed to load rows.</div>';
            return;
        }
        const data = await response.json();
        const rows = data.rows || [];
        if (!rows.length) {
            rowsBox.innerHTML = '<div class="text-muted">No rows found in CSV.</div>';
            return;
        }

        rowsBox.innerHTML = rows.map((r, idx) => `
            <div class="d-flex justify-content-between align-items-center border-bottom py-1">
                <div>
                    <strong>${escapeHtml(r.name || '')}</strong>
                    <div class="small text-muted">${escapeHtml(r.student_id || '')} â€¢ ${escapeHtml(r.role || '')}</div>
                </div>
                <button class="btn btn-sm btn-outline-primary" onclick="selectImportRow(${idx})">Use</button>
            </div>
        `).join('');

        window._importRowsCache = rows;
    } catch (error) {
        console.error('Failed to load rows', error);
        rowsBox.innerHTML = '<div class="text-danger">Failed to load rows.</div>';
    }
}

function selectImportRow(index) {
    const rows = window._importRowsCache || [];
    const row = rows[index];
    if (!row) return;
    document.getElementById('tryName').value = row.name || '';
    document.getElementById('tryStudentId').value = row.student_id || '';
    if (row.role) {
        document.getElementById('tryRole').value = row.role;
    }
}

async function runTryCertificate() {
    const name = document.getElementById('tryName').value.trim();
    const studentId = document.getElementById('tryStudentId').value.trim();
    const role = document.getElementById('tryRole').value;
    const errorBox = document.getElementById('tryError');

    if (!name || !studentId) {
        errorBox.textContent = 'Please enter both name and student ID.';
        errorBox.classList.remove('d-none');
        return;
    }

    try {
        // Directly generate/download the certificate without verification
        const downloadUrl = `/certificate/download?name=${encodeURIComponent(name)}&student_id=${encodeURIComponent(studentId)}&template_id=${encodeURIComponent(currentTryTemplateId)}&role=${encodeURIComponent(role)}`;
        window.open(downloadUrl, '_blank');
        
        // Close modal on success
        bootstrap.Modal.getInstance(document.getElementById('tryModal')).hide();
        errorBox.classList.add('d-none');
    } catch (error) {
        errorBox.textContent = 'Failed to generate certificate. Please try again.';
        errorBox.classList.remove('d-none');
    }
}

async function deleteTemplate() {
    if (!currentDeleteId) return;
    
    try {
        const token = localStorage.getItem('token');
        const response = await fetch(`/admin/templates/${currentDeleteId}`, {
            method: 'DELETE',
            headers: {
                'Authorization': `Bearer ${token}`
            }
        });
        
        if (response.ok) {
            bootstrap.Modal.getInstance(document.getElementById('deleteModal')).hide();
            showSuccess('Template deactivated successfully');
            loadTemplates();
        } else {
            showError('Failed to deactivate template');
        }
    } catch (error) {
        console.error('Error:', error);
        showError('Error deactivating template');
    }
}

function escapeHtml(text) {
    const map = {
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#039;'
    };
    return text.replace(/[&<>"']/g, m => map[m]);
}

function showError(message) {
    const alert = document.createElement('div');
    alert.className = 'alert alert-danger alert-dismissible fade show';
    alert.innerHTML = `
        <i class="fas fa-exclamation-circle"></i> ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    document.body.insertBefore(alert, document.body.firstChild);
}

function showSuccess(message) {
    const alert = document.createElement('div');
    alert.className = 'alert alert-success alert-dismissible fade show';
    alert.innerHTML = `
        <i class="fas fa-check-circle"></i> ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    document.body.insertBefore(alert, document.body.firstChild);
}
</script>
{% endblock %}
